<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simulation de Négociation Commerciale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ... (previous styles remain the same) ... */
        .toggle-btn {
            width: 51px;
            height: 31px;
            background-color: #e9e9ea;
            border-radius: 31px;
            padding: 2px;
            transition: background-color 0.3s;
            cursor: pointer;
        }
        .toggle-btn::after {
            content: '';
            display: block;
            width: 27px;
            height: 27px;
            border-radius: 50%;
            background-color: white;
            box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s;
        }
        .toggle-btn.active {
            background-color: #34C759;
        }
        .toggle-btn.active::after {
            transform: translateX(20px);
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    <div id="splash-screen">
        <div id="moral-text">MORAL</div>
    </div>
    <div class="ios-header sticky top-0 z-10 p-4 text-center shadow-sm flex justify-between items-center">
        <h1 class="text-xl font-semibold flex-grow">Simulation de Négociation Commerciale</h1>
        <div class="flex items-center">
            <span id="sound-status" class="mr-2">Son activé</span>
            <div id="mute-btn" class="toggle-btn active"></div>
        </div>
    </div>
    <!-- ... (rest of the HTML remains the same) ... -->

    <script>
        const API_KEY = 'AIzaSyCjCTUupbc55S477Cr0Eb78H8ETz2pe4_U';
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const speechToTextBtn = document.getElementById('speech-to-text-btn');
        const errorMessage = document.getElementById('error-message');
        const splashScreen = document.getElementById('splash-screen');
        const muteBtn = document.getElementById('mute-btn');
        const soundStatus = document.getElementById('sound-status');

        let conversationHistory = [];
        let isMuted = false;

        const systemPrompt = `Vous êtes un propriétaire d'entreprise marocain participant à une simulation de réunion d'affaires pour pratiquer les compétences de négociation avec des commerciaux. En tant qu'IA jouant le rôle d'un client professionnel, votre objectif est de créer un scénario stimulant où vous définissez le nom de votre entreprise, le secteur auquel elle appartient et le produit que vous cherchez à acheter en fonction du secteur et des besoins de votre entreprise. Votre but est de présenter des arguments logiques et solides contre le produit et son prix, toujours exprimés en dirhams. Tout au long de la conversation, il est crucial de rester dans le personnage et d'adopter un ton strict si le vendeur essaie de détourner la discussion ou d'introduire des sujets sans rapport, en lui rappelant qu'un tel comportement est inapproprié pour une réunion d'affaires et reflète mal sur son professionnalisme et l'entreprise qu'il représente. Dans votre premier message, fournissez le contexte de la simulation et plongez-vous dans le rôle sans révéler qu'il s'agit d'une simulation ou que vous êtes une IA. Évitez de vous définir comme une IA et découragez le vendeur de le faire aussi. Si le vendeur suggère des prix déraisonnablement bas ou des produits déraisonnables, soyez méfiant de son offre. Rappelez-vous, vous devez répondre comme si vous étiez dans une discussion verbale, pas écrite. N'incluez pas de messages de type e-mail avec des salutations, un corps, une clôture et une signature. Et essayez de favoriser des messages courts et pertinents. IMPORTANT: Répondez toujours en français, jamais en anglais.`;

        conversationHistory.push({ role: "user", parts: [{ text: systemPrompt }] });

        function hideSplashScreen() {
            splashScreen.style.opacity = '0';
            splashScreen.style.transition = 'opacity 0.5s ease-out';
            setTimeout(() => {
                splashScreen.style.display = 'none';
            }, 500);
        }

        window.addEventListener('load', () => {
            setTimeout(hideSplashScreen, 2000);
            // Start the conversation with an AI message
            sendInitialAIMessage();
        });

        async function sendInitialAIMessage() {
            const initialUserMessage = "Bonjour, Merci pour le temps que vous m'accordez, quels sont vos besoins aujourd'hui ?";
            conversationHistory.push({ role: "user", parts: [{ text: initialUserMessage }] });

            try {
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: conversationHistory,
                        generationConfig: {
                            temperature: 0.9,
                            topK: 1,
                            topP: 1,
                            maxOutputTokens: 2048,
                            stopSequences: []
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('API Response:', data);

                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                    const aiMessage = data.candidates[0].content.parts[0].text;
                    addMessageToChat('ai', aiMessage);
                    conversationHistory.push({ role: "model", parts: [{ text: aiMessage }] });
                    speak(aiMessage);
                } else {
                    throw new Error('Unexpected response structure from API');
                }
            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = `Erreur: ${error.message}. Veuillez vérifier la console pour plus de détails.`;
            }
        }

        // ... (rest of the JavaScript functions remain the same) ...

        function speak(text) {
            if (!isMuted) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'fr-FR';
                window.speechSynthesis.speak(utterance);
            }
        }

        muteBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            muteBtn.classList.toggle('active');
            soundStatus.textContent = isMuted ? 'Son désactivé' : 'Son activé';
        });

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
