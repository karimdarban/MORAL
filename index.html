<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Negotiation Simulation Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-message {
            max-width: 70%;
        }
        #error-message {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <div class="container mx-auto p-4 flex-grow flex flex-col">
        <h1 class="text-2xl font-bold mb-4">Business Negotiation Simulation</h1>
        <div id="chat-container" class="bg-white p-4 rounded-lg shadow-md flex-grow overflow-y-auto mb-4">
            <!-- Chat messages will be displayed here -->
        </div>
        <div class="flex">
            <input type="text" id="user-input" class="flex-grow border rounded-l-lg p-2" placeholder="Type your message...">
            <button id="send-btn" class="bg-blue-500 text-white px-4 py-2 rounded-r-lg">Send</button>
        </div>
        <div id="error-message"></div>
    </div>

    <script>
        const API_KEY = 'AIzaSyCjCTUupbc55S477Cr0Eb78H8ETz2pe4_U';
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const errorMessage = document.getElementById('error-message');

        let conversationHistory = [];

        const systemPrompt = `You are a Moroccan business owner participating in an advanced business meeting simulation to refine your negotiation skills with sales representatives. Assume the role of a discerning business client with a keen eye for detail and a commitment to securing the best possible deal for your company. Begin by defining your company, including its name, industry, and specific product needs aligned with your business operations. For instance, you might be the CEO of "Atlas Textiles," seeking high-quality fabrics for your manufacturing firm, or the founder of "Casablanca Tech Solutions," looking for cutting-edge software solutions for your tech startup. Your objective is to present strong, logical arguments against the products being offered and their prices, which should always be discussed in Moroccan dirhams. Throughout the conversation, maintain a professional and strict demeanor, especially if the salesperson attempts to divert the discussion or introduces irrelevant topics. Promptly remind them that such behavior is unprofessional and reflects poorly on their company's reputation. In your initial message, set the stage for the simulation by immersing yourself in the role without disclosing that it is a simulation or that you are an AI. Avoid referring to yourself or the salesperson as AI entities and discourage any such references. If the salesperson proposes unreasonably low prices or inappropriate products, be suspicious and challenge their offers rigorously. Your responses should mimic a real-time verbal discussion rather than a written exchange, avoiding email-like structures with greetings and signatures. Aim for concise, relevant messages that keep the conversation focused and professional. This prompt is designed to generate varied scenarios each time it is used, so do not specify the business owner's name, company name, or industry unless necessary. Instead, allow the AI to create diverse and unique situations that will test and enhance your negotiation skills effectively.`;

        conversationHistory.push({ role: "user", parts: [{ text: systemPrompt }] });

        async function sendMessage() {
            const userMessage = userInput.value.trim();
            if (userMessage === '') return;

            addMessageToChat('user', userMessage);
            userInput.value = '';

            conversationHistory.push({ role: "user", parts: [{ text: userMessage }] });

            try {
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: conversationHistory,
                        generationConfig: {
                            temperature: 0.9,
                            topK: 1,
                            topP: 1,
                            maxOutputTokens: 2048,
                            stopSequences: []
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('API Response:', data);  // Log the entire response

                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                    const aiMessage = data.candidates[0].content.parts[0].text;
                    addMessageToChat('ai', aiMessage);
                    conversationHistory.push({ role: "model", parts: [{ text: aiMessage }] });
                } else {
                    throw new Error('Unexpected response structure from API');
                }
            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = `Error: ${error.message}. Please check the console for more details.`;
            }
        }

        function addMessageToChat(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('mb-2', 'p-2', 'rounded', 'chat-message');
            
            if (sender === 'user') {
                messageElement.classList.add('ml-auto', 'bg-blue-100');
            } else {
                messageElement.classList.add('mr-auto', 'bg-gray-100');
            }
            
            messageElement.textContent = message;
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Initial AI message to set the scene
        sendMessage();
    </script>
</body>
</html>
